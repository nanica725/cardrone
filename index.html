<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cardrone - ãƒ‘ãƒ¼ã‚½ãƒŠãƒ«ã‚«ãƒ¼ãƒ‰ãƒ­ãƒ¼ãƒ³ç®¡ç†ãƒ„ãƒ¼ãƒ«</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/luxon@3.4.3/build/global/luxon.min.js"></script>
    <style>
        body {
            font-family: 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .card {
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }
        .card:hover {
            box-shadow: 0 10px 15px rgba(0, 0, 0, 0.1);
        }
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th, td {
            padding: 8px 12px;
            text-align: left;
            border-bottom: 1px solid #e2e8f0;
        }
        th {
            background-color: #f8fafc;
        }
        .btn-primary {
            background-color: #3b82f6;
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.3s ease;
            border: none;
        }
        .btn-primary:hover {
            background-color: #2563eb;
        }
        .btn-secondary {
            background-color: #64748b;
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.3s ease;
            border: none;
        }
        .btn-secondary:hover {
            background-color: #475569;
        }
        .btn-danger {
            background-color: #ef4444;
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.3s ease;
            border: none;
        }
        .btn-danger:hover {
            background-color: #dc2626;
        }
        .btn-success {
            background-color: #10b981;
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.3s ease;
            border: none;
        }
        .btn-success:hover {
            background-color: #059669;
        }
        input, select {
            padding: 0.5rem;
            border: 1px solid #d1d5db;
            border-radius: 0.375rem;
            width: 100%;
        }
        .form-group {
            margin-bottom: 1rem;
        }
        .form-label {
            display: block;
            margin-bottom: 0.25rem;
            font-weight: 500;
            color: #374151;
        }
        .badge {
            padding: 0.25rem 0.5rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        .badge-success {
            background-color: #d1fae5;
            color: #047857;
        }
        .badge-warning {
            background-color: #fef3c7;
            color: #92400e;
        }
        .badge-danger {
            background-color: #fee2e2;
            color: #b91c1c;
        }
        .auto-payment-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 4px;
        }
        .auto-payment-active {
            background-color: #10b981;
        }
        .auto-payment-inactive {
            background-color: #d1d5db;
        }
        .loading-container {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            color: white;
        }
        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }
        .login-card {
            background: white;
            padding: 2rem;
            border-radius: 1rem;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
            text-align: center;
            max-width: 400px;
            width: 100%;
        }
        .google-btn {
            background-color: #db4437;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.3s ease;
            width: 100%;
            margin-bottom: 16px;
        }
        .google-btn:hover {
            background-color: #c23321;
        }
        .anonymous-btn {
            background-color: #6b7280;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.3s ease;
            width: 100%;
        }
        .anonymous-btn:hover {
            background-color: #4b5563;
        }
        .main-container {
            display: none;
        }
        .error-message {
            background-color: #fee2e2;
            color: #b91c1c;
            padding: 1rem;
            border-radius: 0.5rem;
            margin: 1rem 0;
        }
    </style>
</head>
<body>
    <!-- Loading Screen -->
    <div id="loadingScreen" class="loading-container">
        <div class="login-card">
            <div class="loading-spinner"></div>
            <h2 class="text-xl font-semibold text-gray-800 mb-2">Cardroneã‚’èµ·å‹•ä¸­...</h2>
            <p class="text-gray-600">Firebase ã‚’åˆæœŸåŒ–ã—ã¦ã„ã¾ã™</p>
        </div>
    </div>

    <!-- Login Screen -->
    <div id="loginScreen" class="login-container" style="display: none;">
        <div class="login-card">
            <h1 class="text-3xl font-bold text-gray-800 mb-2">Cardrone</h1>
            <p class="text-gray-600 mb-6">ãƒ‘ãƒ¼ã‚½ãƒŠãƒ«ã‚«ãƒ¼ãƒ‰ãƒ­ãƒ¼ãƒ³ç®¡ç†ãƒ„ãƒ¼ãƒ«</p>
            <div class="text-6xl mb-6">ğŸ’³</div>
            
            <button id="googleSignInBtn" class="google-btn">
                <i class="fab fa-google mr-2"></i> Googleã§ãƒ­ã‚°ã‚¤ãƒ³
            </button>
            
            <p class="text-sm text-gray-500 mb-4">ã¾ãŸã¯</p>
            
            <button id="anonymousSignInBtn" class="anonymous-btn">
                <i class="fas fa-user-secret mr-2"></i> åŒ¿åã§ãƒ­ã‚°ã‚¤ãƒ³ï¼ˆãƒ†ã‚¹ãƒˆç”¨ï¼‰
            </button>
            
            <div class="mt-6 text-sm text-gray-500">
                <p><i class="fas fa-cloud mr-1"></i> ã‚¯ãƒ©ã‚¦ãƒ‰åŒæœŸã§ã©ã®ç«¯æœ«ã‹ã‚‰ã§ã‚‚ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½</p>
                <p><i class="fas fa-shield-alt mr-1"></i> ãƒ‡ãƒ¼ã‚¿ã¯å®‰å…¨ã«æš—å·åŒ–ã•ã‚Œã¦ä¿å­˜ã•ã‚Œã¾ã™</p>
            </div>
            
            <div id="loginError" class="error-message" style="display: none;"></div>
        </div>
    </div>

    <!-- Main Application -->
    <div id="mainApp" class="main-container min-h-screen p-4 sm:p-6">
        <div class="container mx-auto max-w-6xl">
            <header class="mb-8 text-center">
                <div class="flex justify-between items-center mb-4">
                    <h1 class="text-3xl font-bold text-white">Cardrone</h1>
                    <div class="flex items-center space-x-4">
                        <span id="userInfo" class="text-white"></span>
                        <button id="signOutBtn" class="btn-secondary">
                            <i class="fas fa-sign-out-alt mr-1"></i> ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
                        </button>
                    </div>
                </div>
                <p class="text-white opacity-90">è¤‡æ•°ã®ã‚«ãƒ¼ãƒ‰ãƒ­ãƒ¼ãƒ³ã®å€Ÿé‡‘ã‚’ç°¡å˜ã«ç®¡ç†ãƒ»è¨ˆç®—ã§ãã¾ã™</p>
            </header>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <!-- Left Column: Form and Summary -->
                <div class="lg:col-span-1">
                    <div class="bg-white rounded-lg shadow p-6 mb-8 card">
                        <h2 class="text-xl font-semibold mb-4 flex items-center">
                            <i class="fas fa-plus-circle text-blue-500 mr-2"></i>æ–°ã—ã„ã‚«ãƒ¼ãƒ‰ãƒ­ãƒ¼ãƒ³ã‚’è¿½åŠ 
                        </h2>
                        <form id="newLoanForm">
                            <div class="form-group">
                                <label for="loanName" class="form-label">ãƒ­ãƒ¼ãƒ³å</label>
                                <input type="text" id="loanName" placeholder="â—‹â—‹éŠ€è¡Œã‚«ãƒ¼ãƒ‰ãƒ­ãƒ¼ãƒ³" required class="w-full">
                            </div>
                            <div class="form-group">
                                <label for="loanAmount" class="form-label">å€Ÿå…¥é¡ (å††)</label>
                                <input type="number" id="loanAmount" min="0" step="1" placeholder="300000" required class="w-full">
                            </div>
                            <div class="form-group">
                                <label for="interestRate" class="form-label">é‡‘åˆ© (å¹´ç‡%)</label>
                                <input type="number" id="interestRate" min="0" step="0.01" placeholder="12.5" required class="w-full">
                            </div>
                            <div class="form-group">
                                <label for="loanDate" class="form-label">å€Ÿå…¥æ—¥</label>
                                <input type="date" id="loanDate" required class="w-full">
                            </div>
                            <div class="mt-2">
                                <div class="mb-2">
                                    <input type="checkbox" id="enableAutoPayment" class="mr-2">
                                    <label for="enableAutoPayment" class="font-medium">è‡ªå‹•å¼•ãè½ã¨ã—è¨­å®š</label>
                                </div>
                                <div id="autoPaymentSettings" class="pl-6 mb-4 hidden">
                                    <div class="form-group">
                                        <label for="paymentDay" class="form-label">æ¯æœˆã®å¼•ãè½ã¨ã—æ—¥</label>
                                        <select id="paymentDay" class="w-full">
                                            <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label for="paymentAmount" class="form-label">å¼•ãè½ã¨ã—é‡‘é¡ (å††)</label>
                                        <input type="number" id="paymentAmount" min="0" step="1" placeholder="10000" class="w-full">
                                    </div>
                                </div>
                            </div>
                            <button type="submit" class="btn-primary w-full">
                                <i class="fas fa-save mr-1"></i> ç™»éŒ²ã™ã‚‹
                            </button>
                        </form>
                    </div>

                    <div class="bg-white rounded-lg shadow p-6 mb-8 card">
                        <h2 class="text-xl font-semibold mb-4 flex items-center">
                            <i class="fas fa-chart-pie text-blue-500 mr-2"></i>å€Ÿé‡‘æ¦‚è¦
                        </h2>
                        <div class="space-y-4">
                            <div>
                                <p class="text-sm text-gray-600">åˆè¨ˆå€Ÿå…¥é¡</p>
                                <p class="text-2xl font-bold" id="totalLoanAmount">Â¥0</p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-600">åˆè¨ˆè¿”æ¸ˆé¡</p>
                                <p class="text-2xl font-bold text-green-600" id="totalRepaidAmount">Â¥0</p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-600">åˆè¨ˆæ®‹å‚µ</p>
                                <p class="text-2xl font-bold text-red-600" id="totalRemainingAmount">Â¥0</p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-600">åˆè¨ˆç™ºç”Ÿåˆ©æ¯</p>
                                <p class="text-xl font-bold text-orange-500" id="totalInterestAmount">Â¥0</p>
                            </div>
                        </div>
                        <div class="mt-6">
                            <canvas id="totalDebtChart" width="400" height="300"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Right Column: Loan List and Details -->
                <div class="lg:col-span-2">
                    <div class="bg-white rounded-lg shadow p-6 card">
                        <h2 class="text-xl font-semibold mb-4 flex items-center">
                            <i class="fas fa-credit-card text-blue-500 mr-2"></i>ã‚«ãƒ¼ãƒ‰ãƒ­ãƒ¼ãƒ³ä¸€è¦§
                        </h2>
                        <div id="noLoansMessage" class="text-center p-8 text-gray-500">
                            <i class="fas fa-info-circle text-3xl mb-2"></i>
                            <p>ã‚«ãƒ¼ãƒ‰ãƒ­ãƒ¼ãƒ³ãŒã¾ã ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚<br>å·¦ã®ãƒ•ã‚©ãƒ¼ãƒ ã‹ã‚‰æ–°ã—ã„ãƒ­ãƒ¼ãƒ³ã‚’è¿½åŠ ã—ã¦ãã ã•ã„ã€‚</p>
                        </div>
                        <div id="loansList" class="space-y-6"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <div id="repaymentModal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-lg p-6 w-full max-w-md mx-auto">
            <h3 class="text-xl font-semibold mb-4">è¿”æ¸ˆã‚’è¨˜éŒ²</h3>
            <form id="repaymentForm">
                <input type="hidden" id="repaymentLoanId">
                <div class="form-group">
                    <label for="repaymentDate" class="form-label">è¿”æ¸ˆæ—¥</label>
                    <input type="date" id="repaymentDate" required>
                </div>
                <div class="form-group">
                    <label for="repaymentAmount" class="form-label">è¿”æ¸ˆé¡ (å††)</label>
                    <input type="number" id="repaymentAmount" min="0" step="1" placeholder="10000" required>
                </div>
                <div class="form-group">
                    <label for="repaymentNote" class="form-label">ãƒ¡ãƒ¢ (ä»»æ„)</label>
                    <input type="text" id="repaymentNote" placeholder="ä¾‹: ãƒœãƒ¼ãƒŠã‚¹è¿”æ¸ˆ">
                </div>
                <div class="flex justify-end space-x-3 mt-4">
                    <button type="button" id="cancelRepayment" class="btn-secondary">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                    <button type="submit" class="btn-primary">è¨˜éŒ²ã™ã‚‹</button>
                </div>
            </form>
        </div>
    </div>

    <div id="autoPaymentModal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-lg p-6 w-full max-w-md mx-auto">
            <h3 class="text-xl font-semibold mb-4">è‡ªå‹•å¼•ãè½ã¨ã—è¨­å®š</h3>
            <form id="autoPaymentForm">
                <input type="hidden" id="autoPaymentLoanId">
                <div class="form-group">
                    <div class="mb-2">
                        <input type="checkbox" id="editEnableAutoPayment" class="mr-2">
                        <label for="editEnableAutoPayment" class="font-medium">è‡ªå‹•å¼•ãè½ã¨ã—ã‚’æœ‰åŠ¹ã«ã™ã‚‹</label>
                    </div>
                </div>
                <div id="editAutoPaymentSettings" class="mb-4">
                    <div class="form-group">
                        <label for="editPaymentDay" class="form-label">æ¯æœˆã®å¼•ãè½ã¨ã—æ—¥</label>
                        <select id="editPaymentDay" class="w-full">
                            <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="editPaymentAmount" class="form-label">å¼•ãè½ã¨ã—é‡‘é¡ (å††)</label>
                        <input type="number" id="editPaymentAmount" min="0" step="1" placeholder="10000" class="w-full">
                    </div>
                </div>
                <div class="flex justify-end space-x-3 mt-4">
                    <button type="button" id="cancelAutoPayment" class="btn-secondary">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                    <button type="submit" class="btn-primary">ä¿å­˜ã™ã‚‹</button>
                </div>
            </form>
        </div>
    </div>

    <div id="editLoanModal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-lg p-6 w-full max-w-md mx-auto">
            <h3 class="text-xl font-semibold mb-4">ãƒ­ãƒ¼ãƒ³æƒ…å ±ã®ç·¨é›†</h3>
            <form id="editLoanForm">
                <input type="hidden" id="editLoanId">
                <div class="form-group">
                    <label for="editLoanName" class="form-label">ãƒ­ãƒ¼ãƒ³å</label>
                    <input type="text" id="editLoanName" required>
                </div>
                <div class="form-group">
                    <label for="editInterestRate" class="form-label">é‡‘åˆ© (å¹´ç‡%)</label>
                    <input type="number" id="editInterestRate" min="0" step="0.01" required>
                </div>
                <div class="flex justify-end space-x-3 mt-4">
                    <button type="button" id="cancelEditLoan" class="btn-secondary">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                    <button type="submit" class="btn-primary">æ›´æ–°ã™ã‚‹</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-firestore-compat.js"></script>

    <script>
        // Debug logging function
        function debugLog(message, data = null) {
            console.log(message, data || '');
        }

        debugLog('Starting app initialization...');

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCGEJMZEHI0QuZVE3aXPMW60FjYUxrFV0s",
            authDomain: "cardrone-1d6c3.firebaseapp.com",
            projectId: "cardrone-1d6c3",
            storageBucket: "cardrone-1d6c3.firebasestorage.app",
            messagingSenderId: "418896032854",
            appId: "1:418896032854:web:1d109b5ced99ad5db6f7f7",
            measurementId: "G-H7GTJ10NMR"
        };

        // Utility functions
        const formatCurrency = (amount) => {
            return new Intl.NumberFormat('ja-JP', {
                style: 'currency',
                currency: 'JPY',
                minimumFractionDigits: 0
            }).format(amount);
        };

        const formatDate = (dateString) => {
            const date = new Date(dateString);
            return date.toLocaleDateString('ja-JP', { 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            });
        };

        const calculateDailyInterest = (amount, annualRate) => {
            const dailyRate = annualRate / 100 / 365;
            return amount * dailyRate;
        };

        // Global variables
        let loans = [];
        let totalDebtChart;
        let currentUser = null;
        let auth, db;

        // Initialize Firebase
        async function initializeFirebase() {
            try {
                debugLog('Firebaseã‚’åˆæœŸåŒ–ä¸­...');
                
                if (typeof firebase === 'undefined') {
                    throw new Error('Firebase SDK not loaded');
                }

                debugLog('Initializing Firebase...');
                firebase.initializeApp(firebaseConfig);
                debugLog('Firebase app initialized');
                
                auth = firebase.auth();
                db = firebase.firestore();
                debugLog('Firebase services initialized');
                
                // Auth state listener
                auth.onAuthStateChanged((user) => {
                    debugLog('Auth state changed:', user ? 'User logged in' : 'User not logged in');
                    if (user) {
                        debugLog('User logged in:', user.uid);
                        currentUser = user;
                        showMainApp();
                        loadUserData();
                    } else {
                        debugLog('User not logged in');
                        currentUser = null;
                        showLoginScreen();
                    }
                });
                
                debugLog('Firebase initialization complete');
                return true;
            } catch (error) {
                debugLog('Firebase initialization error:', error.message);
                showError('FirebaseåˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼: ' + error.message);
                return false;
            }
        }

        // Authentication functions
        async function signInWithGoogle() {
            try {
                debugLog('Starting Google sign in...');
                debugLog('Googleã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§ãƒ­ã‚°ã‚¤ãƒ³ä¸­...');
                const provider = new firebase.auth.GoogleAuthProvider();
                const result = await auth.signInWithPopup(provider);
                debugLog('Google sign in successful:', result.user.uid);
                return result.user;
            } catch (error) {
                debugLog('Google sign in failed:', error);
                showError('ãƒ­ã‚°ã‚¤ãƒ³ã‚¨ãƒ©ãƒ¼: ' + error.message);
                throw error;
            }
        }

        async function signInAnonymously() {
            try {
                debugLog('Starting anonymous sign in...');
                debugLog('åŒ¿åã§ãƒ­ã‚°ã‚¤ãƒ³ä¸­...');
                const result = await auth.signInAnonymously();
                debugLog('Anonymous sign in successful:', result.user.uid);
                return result.user;
            } catch (error) {
                debugLog('Anonymous sign in failed:', error);
                showError('åŒ¿åãƒ­ã‚°ã‚¤ãƒ³ã‚¨ãƒ©ãƒ¼: ' + error.message);
                throw error;
            }
        }

        async function signOut() {
            try {
                debugLog('Signing out...');
                await auth.signOut();
                debugLog('Sign out successful');
            } catch (error) {
                debugLog('Sign out failed:', error);
                showError('ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã‚¨ãƒ©ãƒ¼: ' + error.message);
            }
        }

        // Firestore functions
        async function loadUserData() {
            if (!currentUser) return;
            
            try {
                debugLog('Loading user data...');
                const userDoc = await db.collection('users').doc(currentUser.uid).get();
                
                if (userDoc.exists) {
                    const userData = userDoc.data();
                    loans = userData.loans || [];
                    debugLog('User data loaded:', loans.length + ' loans');
                } else {
                    debugLog('No user data found, creating new document');
                    loans = [];
                    await saveUserData();
                }
                
                updateUI();
            } catch (error) {
                debugLog('Error loading user data:', error);
                showError('ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼: ' + error.message);
            }
        }

        async function saveUserData() {
            if (!currentUser) return;
            
            try {
                debugLog('Saving user data...');
                await db.collection('users').doc(currentUser.uid).set({
                    loans: loans,
                    lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                });
                debugLog('User data saved successfully');
            } catch (error) {
                debugLog('Error saving user data:', error);
                showError('ãƒ‡ãƒ¼ã‚¿ä¿å­˜ã‚¨ãƒ©ãƒ¼: ' + error.message);
            }
        }

        // UI functions
        function showError(message) {
            const errorElement = document.getElementById('loginError');
            if (errorElement) {
                errorElement.textContent = message;
                errorElement.style.display = 'block';
                setTimeout(() => {
                    errorElement.style.display = 'none';
                }, 5000);
            }
            console.error('Error:', message);
        }

        function showLoadingScreen() {
            document.getElementById('loadingScreen').style.display = 'flex';
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('mainApp').style.display = 'none';
        }

        function showLoginScreen() {
            document.getElementById('loadingScreen').style.display = 'none';
            document.getElementById('loginScreen').style.display = 'flex';
            document.getElementById('mainApp').style.display = 'none';
        }

        function showMainApp() {
            document.getElementById('loadingScreen').style.display = 'none';
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('mainApp').style.display = 'block';
            
            // Update user info
            const userInfo = document.getElementById('userInfo');
            if (currentUser) {
                const displayName = currentUser.displayName || currentUser.email || 'åŒ¿åãƒ¦ãƒ¼ã‚¶ãƒ¼';
                userInfo.textContent = displayName;
            }
        }

        // Initialize app
        document.addEventListener('DOMContentLoaded', async () => {
            debugLog('DOM loaded, initializing app...');
            
            // Show loading screen
            showLoadingScreen();
            
            // Initialize Firebase
            const firebaseInitialized = await initializeFirebase();
            
            if (firebaseInitialized) {
                debugLog('èªè¨¼çŠ¶æ…‹ã‚’ç¢ºèªä¸­...');
                
                // Setup event listeners
                setupEventListeners();
                
                // Initialize other components
                initializeComponents();
                
                debugLog('App initialization complete');
            } else {
                showError('ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼: Firebase initialization failed');
            }
        });

        function setupEventListeners() {
            // Auth buttons
            document.getElementById('googleSignInBtn').addEventListener('click', signInWithGoogle);
            document.getElementById('anonymousSignInBtn').addEventListener('click', signInAnonymously);
            document.getElementById('signOutBtn').addEventListener('click', signOut);
            
            // Form submissions
            document.getElementById('newLoanForm').addEventListener('submit', handleNewLoanSubmit);
            document.getElementById('repaymentForm').addEventListener('submit', handleRepaymentSubmit);
            document.getElementById('autoPaymentForm').addEventListener('submit', handleAutoPaymentSubmit);
            document.getElementById('editLoanForm').addEventListener('submit', handleEditLoanSubmit);
            
            // Modal cancel buttons
            document.getElementById('cancelRepayment').addEventListener('click', () => {
                document.getElementById('repaymentModal').classList.add('hidden');
            });
            document.getElementById('cancelAutoPayment').addEventListener('click', () => {
                document.getElementById('autoPaymentModal').classList.add('hidden');
            });
            document.getElementById('cancelEditLoan').addEventListener('click', () => {
                document.getElementById('editLoanModal').classList.add('hidden');
            });
            
            // Auto payment settings toggle
            document.getElementById('enableAutoPayment').addEventListener('change', function() {
                document.getElementById('autoPaymentSettings').classList.toggle('hidden', !this.checked);
            });
            document.getElementById('editEnableAutoPayment').addEventListener('change', function() {
                document.getElementById('editAutoPaymentSettings').classList.toggle('hidden', !this.checked);
            });
        }

        function initializeComponents() {
            // Initialize the current date for loan date
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('loanDate').value = today;
            document.getElementById('repaymentDate').value = today;

            // Populate day select boxes
            const daySelects = [document.getElementById('paymentDay'), document.getElementById('editPaymentDay')];
            daySelects.forEach(select => {
                for (let i = 1; i <= 31; i++) {
                    const option = document.createElement('option');
                    option.value = i;
                    option.textContent = `${i}æ—¥`;
                    select.appendChild(option);
                }
                // Add end of month option
                const endOption = document.createElement('option');
                endOption.value = 'end';
                endOption.textContent = 'æœˆæœ«';
                select.appendChild(endOption);
            });

            // Initialize chart
            initializeChart();
        }

        // Form handlers
        async function handleNewLoanSubmit(event) {
            event.preventDefault();
            
            const name = document.getElementById('loanName').value;
            const amount = parseFloat(document.getElementById('loanAmount').value);
            const interestRate = parseFloat(document.getElementById('interestRate').value);
            const loanDate = document.getElementById('loanDate').value;
            const enableAutoPayment = document.getElementById('enableAutoPayment').checked;
            
            let autoPayment = null;
            if (enableAutoPayment) {
                const paymentDay = document.getElementById('paymentDay').value;
                const paymentAmount = parseFloat(document.getElementById('paymentAmount').value);
                
                if (!paymentDay || isNaN(paymentAmount) || paymentAmount <= 0) {
                    alert('è‡ªå‹•å¼•ãè½ã¨ã—è¨­å®šã«ä¸å‚™ãŒã‚ã‚Šã¾ã™ã€‚å¼•ãè½ã¨ã—æ—¥ã¨é‡‘é¡ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
                    return;
                }
                
                autoPayment = {
                    day: paymentDay,
                    amount: paymentAmount,
                    enabled: true
                };
            }

            const newLoan = {
                id: Date.now().toString(),
                name: name,
                initialAmount: amount,
                currentAmount: amount,
                interestRate: interestRate,
                loanDate: loanDate,
                autoPayment: autoPayment,
                repayments: [],
                interestAccrued: 0
            };

            loans.push(newLoan);
            await saveUserData();
            
            // Reset form
            document.getElementById('newLoanForm').reset();
            document.getElementById('loanDate').value = new Date().toISOString().split('T')[0];
            document.getElementById('autoPaymentSettings').classList.add('hidden');
            
            updateUI();
        }

        async function handleRepaymentSubmit(event) {
            event.preventDefault();
            
            const loanId = document.getElementById('repaymentLoanId').value;
            const date = document.getElementById('repaymentDate').value;
            const amount = parseFloat(document.getElementById('repaymentAmount').value);
            const note = document.getElementById('repaymentNote').value;
            
            const loan = loans.find(l => l.id === loanId);
            if (!loan) return;
            
            // Calculate interest accrued since last repayment or loan creation
            let lastDate = loan.loanDate;
            if (loan.repayments.length > 0) {
                loan.repayments.sort((a, b) => new Date(a.date) - new Date(b.date));
                lastDate = loan.repayments[loan.repayments.length - 1].date;
            }
            
            const daysSinceLastPayment = (new Date(date) - new Date(lastDate)) / (1000 * 60 * 60 * 24);
            const interestAccrued = calculateDailyInterest(loan.currentAmount, loan.interestRate) * daysSinceLastPayment;
            
            // Add interest to the loan
            loan.interestAccrued += interestAccrued;
            loan.currentAmount += interestAccrued;
            
            // Apply payment
            const newAmount = Math.max(0, loan.currentAmount - amount);
            
            const repayment = {
                date: date,
                amount: amount,
                note: note,
                interestAccrued: interestAccrued,
                remainingAmount: newAmount,
                automatic: false
            };
            
            loan.repayments.push(repayment);
            loan.currentAmount = newAmount;
            
            await saveUserData();
            document.getElementById('repaymentModal').classList.add('hidden');
            updateUI();
        }

        async function handleAutoPaymentSubmit(event) {
            event.preventDefault();
            
            const loanId = document.getElementById('autoPaymentLoanId').value;
            const enableAutoPayment = document.getElementById('editEnableAutoPayment').checked;
            
            const loan = loans.find(l => l.id === loanId);
            if (!loan) return;
            
            if (enableAutoPayment) {
                const paymentDay = document.getElementById('editPaymentDay').value;
                const paymentAmount = parseFloat(document.getElementById('editPaymentAmount').value);
                
                if (!paymentDay || isNaN(paymentAmount) || paymentAmount <= 0) {
                    alert('è‡ªå‹•å¼•ãè½ã¨ã—è¨­å®šã«ä¸å‚™ãŒã‚ã‚Šã¾ã™ã€‚å¼•ãè½ã¨ã—æ—¥ã¨é‡‘é¡ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
                    return;
                }
                
                loan.autoPayment = {
                    day: paymentDay,
                    amount: paymentAmount,
                    enabled: true
                };
            } else {
                if (loan.autoPayment) {
                    loan.autoPayment.enabled = false;
                } else {
                    loan.autoPayment = {
                        day: '1',
                        amount: 0,
                        enabled: false
                    };
                }
            }
            
            await saveUserData();
            document.getElementById('autoPaymentModal').classList.add('hidden');
            updateUI();
        }

        async function handleEditLoanSubmit(event) {
            event.preventDefault();
            
            const loanId = document.getElementById('editLoanId').value;
            const name = document.getElementById('editLoanName').value;
            const interestRate = parseFloat(document.getElementById('editInterestRate').value);
            
            const loan = loans.find(l => l.id === loanId);
            if (!loan) return;
            
            loan.name = name;
            loan.interestRate = interestRate;
            
            await saveUserData();
            document.getElementById('editLoanModal').classList.add('hidden');
            updateUI();
        }

        // Modal functions
        function openRepaymentModal(loanId) {
            const loan = loans.find(l => l.id === loanId);
            if (!loan) return;
            
            document.getElementById('repaymentLoanId').value = loanId;
            document.getElementById('repaymentDate').value = new Date().toISOString().split('T')[0];
            document.getElementById('repaymentAmount').value = '';
            document.getElementById('repaymentNote').value = '';
            
            document.getElementById('repaymentModal').classList.remove('hidden');
        }

        function openAutoPaymentModal(loanId) {
            const loan = loans.find(l => l.id === loanId);
            if (!loan) return;
            
            document.getElementById('autoPaymentLoanId').value = loanId;
            
            if (loan.autoPayment) {
                document.getElementById('editEnableAutoPayment').checked = loan.autoPayment.enabled;
                document.getElementById('editPaymentDay').value = loan.autoPayment.day;
                document.getElementById('editPaymentAmount').value = loan.autoPayment.amount;
                document.getElementById('editAutoPaymentSettings').classList.toggle('hidden', !loan.autoPayment.enabled);
            } else {
                document.getElementById('editEnableAutoPayment').checked = false;
                document.getElementById('editPaymentDay').value = '';
                document.getElementById('editPaymentAmount').value = '';
                document.getElementById('editAutoPaymentSettings').classList.add('hidden');
            }
            
            document.getElementById('autoPaymentModal').classList.remove('hidden');
        }

        function openEditLoanModal(loanId) {
            const loan = loans.find(l => l.id === loanId);
            if (!loan) return;
            
            document.getElementById('editLoanId').value = loanId;
            document.getElementById('editLoanName').value = loan.name;
            document.getElementById('editInterestRate').value = loan.interestRate;
            
            document.getElementById('editLoanModal').classList.remove('hidden');
        }

        async function deleteLoan(loanId) {
            if (!confirm('ã“ã®ãƒ­ãƒ¼ãƒ³ã‚’å‰Šé™¤ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿã“ã®æ“ä½œã¯å…ƒã«æˆ»ã›ã¾ã›ã‚“ã€‚')) {
                return;
            }
            
            const index = loans.findIndex(l => l.id === loanId);
            if (index !== -1) {
                loans.splice(index, 1);
                await saveUserData();
                updateUI();
            }
        }

        async function deleteRepayment(loanId, repaymentIndex) {
            if (!confirm('ã“ã®è¿”æ¸ˆè¨˜éŒ²ã‚’å‰Šé™¤ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿã“ã®æ“ä½œã¯å…ƒã«æˆ»ã›ã¾ã›ã‚“ã€‚')) {
                return;
            }
            
            const loan = loans.find(l => l.id === loanId);
            if (!loan) return;
            
            // This is a simplified implementation and doesn't recalculate interest properly
            // A more accurate implementation would recalculate all subsequent repayments
            loan.repayments.splice(repaymentIndex, 1);
            
            // Recalculate the current amount based on initial amount and all remaining repayments
            loan.currentAmount = loan.initialAmount;
            loan.interestAccrued = 0;
            
            let lastDate = loan.loanDate;
            
            if (loan.repayments.length > 0) {
                // Sort repayments by date
                loan.repayments.sort((a, b) => new Date(a.date) - new Date(b.date));
                
                // Recalculate for each repayment
                for (let i = 0; i < loan.repayments.length; i++) {
                    const repayment = loan.repayments[i];
                    
                    // Calculate interest since last date
                    const daysSinceLastPayment = (new Date(repayment.date) - new Date(lastDate)) / (1000 * 60 * 60 * 24);
                    const interestAccrued = calculateDailyInterest(loan.currentAmount, loan.interestRate) * daysSinceLastPayment;
                    
                    // Update loan values
                    loan.interestAccrued += interestAccrued;
                    loan.currentAmount += interestAccrued;
                    
                    // Apply payment
                    loan.currentAmount = Math.max(0, loan.currentAmount - repayment.amount);
                    
                    // Update repayment record
                    repayment.interestAccrued = interestAccrued;
                    repayment.remainingAmount = loan.currentAmount;
                    
                    // Update last date
                    lastDate = repayment.date;
                }
            }
            
            await saveUserData();
            updateUI();
        }

        // Chart functions
        function initializeChart() {
            const ctx = document.getElementById('totalDebtChart').getContext('2d');
            totalDebtChart = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: ['æ®‹å‚µ', 'è¿”æ¸ˆæ¸ˆã¿'],
                    datasets: [{
                        data: [0, 0],
                        backgroundColor: [
                            'rgba(239, 68, 68, 0.7)',
                            'rgba(16, 185, 129, 0.7)'
                        ],
                        borderColor: [
                            'rgba(239, 68, 68, 1)',
                            'rgba(16, 185, 129, 1)'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }

        // UI update functions
        function updateUI() {
            updateLoansDisplay();
            updateSummaryStatistics();
        }

        function updateLoansDisplay() {
            const loansListElement = document.getElementById('loansList');
            const noLoansMessage = document.getElementById('noLoansMessage');
            
            if (loans.length === 0) {
                noLoansMessage.classList.remove('hidden');
                loansListElement.classList.add('hidden');
            } else {
                noLoansMessage.classList.add('hidden');
                loansListElement.classList.remove('hidden');
                
                loansListElement.innerHTML = '';
                
                // Sort loans by remaining amount (highest first)
                const sortedLoans = [...loans].sort((a, b) => b.currentAmount - a.currentAmount);
                
                sortedLoans.forEach(loan => {
                    const loanElement = createLoanElement(loan);
                    loansListElement.appendChild(loanElement);
                });
            }
        }

        function createLoanElement(loan) {
            const loanCard = document.createElement('div');
            loanCard.className = 'bg-gray-50 rounded-lg p-4 shadow-sm border border-gray-200';
            
            // Calculate total paid amount
            const totalPaid = loan.repayments.reduce((sum, repayment) => sum + repayment.amount, 0);
            // Calculate percentages for progress bar
            const percentagePaid = loan.initialAmount > 0 ? Math.min(100, (totalPaid / loan.initialAmount) * 100) : 0;
            const percentageInterest = loan.initialAmount > 0 ? (loan.interestAccrued / loan.initialAmount) * 100 : 0;
            
            // Determine status badge
            let statusBadge = '';
            if (loan.currentAmount === 0) {
                statusBadge = '<span class="badge badge-success">å®Œæ¸ˆæ¸ˆã¿</span>';
            } else if (loan.currentAmount / loan.initialAmount < 0.5) {
                statusBadge = '<span class="badge badge-warning">è¿”æ¸ˆä¸­</span>';
            } else {
                statusBadge = '<span class="badge badge-danger">å€Ÿå…¥ä¸­</span>';
            }
            
            // Auto payment indicator
            let autoPaymentIndicator = '';
            if (loan.autoPayment && loan.autoPayment.enabled) {
                const dayText = loan.autoPayment.day === 'end' ? 'æœˆæœ«' : `${loan.autoPayment.day}æ—¥`;
                autoPaymentIndicator = `
                    <div class="flex items-center text-sm text-gray-600 mt-1">
                        <span class="auto-payment-indicator auto-payment-active"></span>
                        æ¯æœˆ${dayText}ã«${formatCurrency(loan.autoPayment.amount)}è‡ªå‹•å¼•ãè½ã¨ã—
                    </div>
                `;
            }
            
            loanCard.innerHTML = `
                <div class="flex justify-between items-start">
                    <div>
                        <h3 class="text-lg font-semibold flex items-center">
                            ${loan.name} ${statusBadge}
                        </h3>
                        ${autoPaymentIndicator}
                    </div>
                    <div class="space-x-2">
                        <button class="text-blue-600 hover:text-blue-800" onclick="openEditLoanModal('${loan.id}')">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="text-red-600 hover:text-red-800" onclick="deleteLoan('${loan.id}')">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    </div>
                </div>
                
                <div class="mt-3 grid grid-cols-2 gap-3">
                    <div>
                        <p class="text-sm text-gray-600">å€Ÿå…¥æ—¥</p>
                        <p class="font-medium">${formatDate(loan.loanDate)}</p>
                    </div>
                    <div>
                        <p class="text-sm text-gray-600">é‡‘åˆ© (å¹´ç‡)</p>
                        <p class="font-medium">${loan.interestRate}%</p>
                    </div>
                    <div>
                        <p class="text-sm text-gray-600">åˆæœŸå€Ÿå…¥é¡</p>
                        <p class="font-medium">${formatCurrency(loan.initialAmount)}</p>
                    </div>
                    <div>
                        <p class="text-sm text-gray-600">ç¾åœ¨æ®‹é«˜</p>
                        <p class="font-medium text-red-600">${formatCurrency(loan.currentAmount)}</p>
                    </div>
                </div>
                
                <div class="mt-3">
                    <div class="flex justify-between text-sm mb-1">
                        <span>è¿”æ¸ˆé€²æ—çŠ¶æ³</span>
                        <span>${Math.round(percentagePaid)}% å®Œäº†</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-2.5 mb-3">
                        <div class="bg-green-600 h-2.5 rounded-full" style="width: ${percentagePaid}%"></div>
                    </div>
                    <div class="flex justify-between text-sm mb-1">
                        <span>åˆ©æ¯ç™ºç”ŸçŠ¶æ³</span>
                        <span>${formatCurrency(loan.interestAccrued)} (${Math.round(percentageInterest)}%)</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-2.5 mb-3">
                        <div class="bg-orange-500 h-2.5 rounded-full" style="width: ${percentageInterest}%"></div>
                    </div>
                </div>
                
                <div class="mt-4 flex justify-between">
                    <button class="btn-primary" onclick="openRepaymentModal('${loan.id}')">
                        <i class="fas fa-money-bill-wave mr-1"></i> è¿”æ¸ˆã‚’è¨˜éŒ²
                    </button>
                    <button class="btn-secondary" onclick="openAutoPaymentModal('${loan.id}')">
                        <i class="fas fa-calendar-alt mr-1"></i> è‡ªå‹•å¼•ãè½ã¨ã—è¨­å®š
                    </button>
                </div>
                
                <div class="mt-4">
                    <h4 class="font-medium mb-2">è¿”æ¸ˆå±¥æ­´</h4>
                    ${loan.repayments.length === 0 ? '<p class="text-sm text-gray-500 text-center py-2">è¿”æ¸ˆå±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“</p>' : ''}
                    ${loan.repayments.length > 0 ? `
                        <div class="max-h-48 overflow-y-auto">
                            <table class="w-full">
                                <thead>
                                    <tr>
                                        <th>æ—¥ä»˜</th>
                                        <th>è¿”æ¸ˆé¡</th>
                                        <th>æ®‹é«˜</th>
                                        <th></th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${loan.repayments.sort((a, b) => new Date(b.date) - new Date(a.date)).map((repayment, index) => `
                                        <tr class="${repayment.automatic ? 'bg-blue-50' : ''}">
                                            <td>${formatDate(repayment.date)}</td>
                                            <td>${formatCurrency(repayment.amount)}</td>
                                            <td>${formatCurrency(repayment.remainingAmount)}</td>
                                            <td class="text-right">
                                                <button class="text-red-600 hover:text-red-800" onclick="deleteRepayment('${loan.id}', ${loan.repayments.indexOf(repayment)})">
                                                    <i class="fas fa-times"></i>
                                                </button>
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    ` : ''}
                </div>
            `;
            
            return loanCard;
        }

        function updateSummaryStatistics() {
            const totalLoanAmount = loans.reduce((sum, loan) => sum + loan.initialAmount, 0);
            const totalRepaidAmount = loans.reduce((sum, loan) => sum + loan.repayments.reduce((sum, r) => sum + r.amount, 0), 0);
            const totalRemainingAmount = loans.reduce((sum, loan) => sum + loan.currentAmount, 0);
            const totalInterestAmount = loans.reduce((sum, loan) => sum + loan.interestAccrued, 0);
            
            document.getElementById('totalLoanAmount').textContent = formatCurrency(totalLoanAmount);
            document.getElementById('totalRepaidAmount').textContent = formatCurrency(totalRepaidAmount);
            document.getElementById('totalRemainingAmount').textContent = formatCurrency(totalRemainingAmount);
            document.getElementById('totalInterestAmount').textContent = formatCurrency(totalInterestAmount);
            
            // Update chart
            totalDebtChart.data.datasets[0].data = [totalRemainingAmount, totalRepaidAmount - totalInterestAmount];
            totalDebtChart.update();
        }

        // Auto payment processing
        function checkAutomaticPayments() {
            const today = new Date();
            const currentDay = today.getDate();
            const isLastDay = new Date(today.getFullYear(), today.getMonth() + 1, 0).getDate() === currentDay;
            
            loans.forEach(loan => {
                if (loan.autoPayment && loan.autoPayment.enabled && loan.currentAmount > 0) {
                    const shouldProcess = 
                        (loan.autoPayment.day === 'end' && isLastDay) || 
                        (parseInt(loan.autoPayment.day) === currentDay);
                    
                    if (shouldProcess) {
                        // Check if we already have an automatic payment for today
                        const todayString = today.toISOString().split('T')[0];
                        const alreadyProcessed = loan.repayments.some(r => 
                            r.date === todayString && r.automatic === true
                        );
                        
                        if (!alreadyProcessed) {
                            processAutomaticPayment(loan, todayString);
                        }
                    }
                }
            });
        }

        async function processAutomaticPayment(loan, date) {
            // Calculate interest accrued since last repayment
            let lastDate = loan.loanDate;
            if (loan.repayments.length > 0) {
                loan.repayments.sort((a, b) => new Date(a.date) - new Date(b.date));
                lastDate = loan.repayments[loan.repayments.length - 1].date;
            }
            
            const daysSinceLastPayment = (new Date(date) - new Date(lastDate)) / (1000 * 60 * 60 * 24);
            const interestAccrued = calculateDailyInterest(loan.currentAmount, loan.interestRate) * daysSinceLastPayment;
            
            // Add interest to the loan
            loan.interestAccrued += interestAccrued;
            loan.currentAmount += interestAccrued;
            
            // Determine payment amount (don't overpay)
            const paymentAmount = Math.min(loan.autoPayment.amount, loan.currentAmount);
            
            // Apply payment
            const newAmount = loan.currentAmount - paymentAmount;
            
            const repayment = {
                date: date,
                amount: paymentAmount,
                note: 'è‡ªå‹•å¼•ãè½ã¨ã—',
                interestAccrued: interestAccrued,
                remainingAmount: newAmount,
                automatic: true
            };
            
            loan.repayments.push(repayment);
            loan.currentAmount = newAmount;
            
            await saveUserData();
        }

        // Check for automatic payments when the app loads
        setInterval(checkAutomaticPayments, 60000 * 60 * 24); // Check daily
    </script>
</body>
</html>
